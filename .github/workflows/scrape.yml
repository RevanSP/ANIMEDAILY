name: Scrape Anime List (Go + chromedp)

on:
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        batch: [0, 1]
      fail-fast: false
    env:
      TZ: "Asia/Jakarta"
      CHROME_BIN: /usr/bin/google-chrome

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ§  Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: ðŸ§° Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: ðŸ“¦ Install dependencies
        run: go mod tidy

      - name: ðŸ•¸ï¸ Run scraper batch ${{ matrix.batch }}
        env:
          BATCH_INDEX: ${{ matrix.batch }}
          BATCH_SIZE: 10
        run: |
          go run main.go

      - name: ðŸ’¾ Upload batch result
        uses: actions/upload-artifact@v4
        with:
          name: anime-data-batch-${{ matrix.batch }}
          path: public/anime.json
          retention-days: 1

  combine:
    needs: scrape
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: anime-data-batch-*

      - name: Combine JSON files
        run: |
          node -e "
          const fs = require('fs'), path = require('path');
          const out = [], seen = new Set();
          for (const dir of fs.readdirSync('artifacts')) {
            for (const f of fs.readdirSync(path.join('artifacts', dir))) {
              if (f.endsWith('.json')) {
                const data = JSON.parse(fs.readFileSync(path.join('artifacts', dir, f), 'utf8'));
                data.forEach(anime => {
                  const key = anime.title + anime.url;
                  if (!seen.has(key)) { seen.add(key); out.push(anime); }
                });
              }
            }
          }
          fs.mkdirSync('public', {recursive:true});
          fs.writeFileSync('public/anime.json', JSON.stringify(out, null, 2));
          console.log('âœ… Combined', out.length, 'anime entries');
          "

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update combined anime.json"
          file_pattern: public/anime.json